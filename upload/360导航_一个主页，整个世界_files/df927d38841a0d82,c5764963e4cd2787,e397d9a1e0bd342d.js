(function(){function e(e,t){this.targetWin=e,this.origin=t||"*",this.handlers={},this.listened=!1,this.setEncodeDecoder(1)}e.type=["send","ask","answer"],e.typeCode={};for(var t=0;t<e.type.length;t++)e.typeCode[e.type[t]]=t;e.prototype.on=function(e,t){var n=this.handlers;n[e]=n[e]||[],n[e].push(t)},e.prototype.fire=function(e,t,n){var r=this.handlers[e];if(!r)return;for(var i=0;i<r.length;i++)r[i](t,n)},e.prototype.un=function(e){var t=this.handlers[e];t&&(this.handlers[e]=null,delete this.handlers[e])},e.encoder1=function(e,t,n,r){var i={"&":n,"#":e,"%":t};return typeof r=="string"&&(i["@"]=r),i},e.encoder2=function(t,n,r,i){var s=e.encoder1(t,n,r,i);return s.v="2",JSON.stringify(s)},e.decoder1=function(t){return{messageId:t["&"]||"",typeId:t["%"]||e.typeCode.send,action:t["@"]||"",body:t["#"]||t}},e.decoder2=function(t){var n=e.decoder1(t);return n.version=t.v,n},e.prototype.setEncodeDecoder=function(t){this.encodeData=e["encoder"+t],this.decodeData=e["decoder"+t]},e.prototype.send=function(e){this.targetWin.postMessage(e,this.origin)},e.prototype.ask=function(t,n,r){var i=cubeLib.uniqId(6),s=this.encodeData(n,e.typeCode.ask,i,t),o=this;r&&typeof r=="function"&&(this.listen(),this.on("answer:"+i,function(e){r(e),o.un("answer:"+i)})),this.targetWin.postMessage(s,this.origin)},e.prototype.answer=function(t,n){var r=this.encodeData(n,e.typeCode.answer,t);this.targetWin.postMessage(r,this.origin)},e.addEvent=function(e,t){window.addEventListener?window.addEventListener(e,t,!1):window.attachEvent&&window.attachEvent("on"+e,t)},e.dataPaser=function(e){var t="1";return typeof e=="object"&&e.v?t=e.v:typeof e=="string"&&(e=JSON.parse(e),typeof e=="object"&&e.v&&(t=e.v)),{version:t,data:e}},e.prototype.listen=function(){if(!this.listened){var t=this;e.addEvent("message",function(n){if(t.origin!=="*"&&n.origin!==t.origin)return;var r=e.dataPaser(n.data);t.setEncodeDecoder(r.version);var i=t.decodeData(r.data),s=!1;switch(i.typeId){case e.typeCode.answer:t.fire("answer:"+i.messageId,i.body);break;case e.typeCode.ask:t.fire(i.action,i.body,function(e){s||(t.answer(i.messageId,e),s=!0)});break;case e.typeCode.send:t.fire("message",i.body)}}),this.listened=!0}return this},window.MessageChannel=e})();(function(){function e(e){return e.status>=200&&e.status<300?!0:!1}function t(t,n,r){var i=t.indexOf("?")!==-1?"&":"?";return t=t+i+qboot.encodeURIJson(n),new Promise(function(n,i){var s=setTimeout(function(){i({status:"error",reason:"timeout"})},r.timeout);fetch(t,r).then(function(t){clearTimeout(s),e(t)?n(t.json()):i({status:"error",reason:"error response code"})},function(e){clearTimeout(s),i(e)})})}window.fetchData=t})();(function(){var e={},t="https://hao.360.com",n=function(){var e=document.referrer,t="";if(e!==""){var n=document.createElement("a");n.href=e,t=n.protocol+"//"+n.host,/:(443|80)$/.test(t)&&(t=t.replace(/:(443|80)$/,""))}return t}(),r=location.search.match(/[?&]appid=(.*?)(&|$)/),i=r!==null?r[1]:"",s=!1,o,u=window.allowReferrerMap;location.hostname!=="cube.3600.com"?o=[/^http:\/\/localhost(:\d+)?$/i,/^http:\/\/127\.0\.0\.1(:\d+)?$/i,/^http:\/\/10\.\d{1,3}\.\d{1,3}\.\d{1,3}(:\d+)?$/i,/^http:\/\/192\.168\.\d{1,3}\.\d{1,3}(:\d+)?$/i,/^https?:\/\/[\w\-]+\.hao\.360\.(com|cn)(:\d+)?$/i,/^https?:\/\/[\w\-]+\.cube\.so\.com(:\d+)?$/i]:o=[/^https:\/\/hao\.360\.com(:\d+)?$/i];var a=function(){var e=u&&u[i];return e===n||e&&e.split(",")&&u[i].split(",").indexOf(n)>-1};i&&a()&&(s=!0,t=n);if(!s)for(var f=0,l=o.length;f<l;f++){var c=o[f];if(c.test(n)){s=!0,t=n;break}}if(!s)throw new Error("Not Allow!");var h=(new MessageChannel(parent,t)).listen();h.send("proxyOk"),h.on("setApiWhiteList",function(t,n){var r=t.api,i=t.id;e[i]=r,n({res:"success"})}),h.on("sendApi",function(t,n){var r=t.api.split(":"),i=r[0],s=r[1],o=e[i]&&e[i][s],u=o.host,a=o.offline;if(!o){n({err:{status:"error",reason:"api not found"}});return}if(u===undefined){a?n({err:a}):n({err:{status:"error",reason:"offline is not defined"}});return}var f=o.timeout<3e4?o.timeout:3e4,l=o.cb||"callback",c=qboot.mix(t.data,o.data,!0),h=o.usefetch,p=o.api_type,d=o.cube_id,v=o.fetch_include_cookie,m=function(e,t,r){var i=v?"include":"same-origin";fetchData(e,t,{timeout:r,mode:"cors",credentials:i}).then(function(e){n({res:e,err:a})}).catch(function(e){e=a||e,n({res:undefined,err:e})})};if(!p||p==="secure_domain")h&&window.fetch?m(u,c,f):qboot.jsonp(u,c,function(e,t){t=a||t,n({res:e,err:t})},{jsonp:l,timeout:f,threshold:f});else if(p==="white_list")if(window.fetch)m(u,c,f);else{var g=u.indexOf("?")!==-1?"&":"?",y={u:u+g+qboot.encodeURIJson(c),cubeid:d},b="https://cubeproxy.dhrest.com?"+qboot.encodeURIJson(y);qboot.jsonp(b,function(e,t){t=a||t,e&&e.errno===0?n({res:e.data,err:t}):n({err:e||t})},{jsonp:l,timeout:f,threshold:f})}});var p={limitSize:4096,getAll:function(e){try{var t=JSON.parse(localStorage.getItem(e))}catch(n){}return Object.prototype.toString.call(t)==="[object Object]"?t:{}},get:function(e,t){var n=this.getAll(e);return n[t]},set:function(e,t,n){var r=this.getAll(e);r[t]=n,n==null&&delete r[t];var i=JSON.stringify(r),s={};if(this.size(i)>this.limitSize)s.err={status:"error",reason:"exceed size limit"};else{s.res="success";if(i!=="{}")try{localStorage.setItem(e,i)}catch(o){}else this.clear(e)}return s},clear:function(e){try{localStorage.removeItem(e)}catch(t){}},remove:function(e,t){this.set(e,t,null)},info:function(e){var t={};try{var n=localStorage.getItem(e)}catch(r){var n=null}return n==null?t.err={status:"error",reason:"storage not found"}:t.res={keys:this.keys(e),currentSize:this.size(n),limitSize:this.limitSize},t},keys:function(e){var t=[],n=this.getAll(e);for(var r in n)t.push(r);return t},size:function(e){return e.replace(/[^\u0000-\u00ff]/g,"aa").length}};h.on("setStorage",function(e,t){var n=e.id,r=p.set(n,e.key,e.data);t(r)}),h.on("getStorage",function(e,t){var n=e.id,r=p.get(n,e.key);t({res:r})}),h.on("clearStorage",function(e,t){var n=e.id;p.clear(n),t({res:"success"})}),h.on("removeStorage",function(e,t){var n=e.id;p.remove(n,e.key),t({res:"success"})}),h.on("getStorageInfo",function(e,t){var n=e.id,r=p.info(n);t(r)})})();